# ADR: Размещение оркестраторач
## Общая информация 

1. Родительский артефакт: [Task1: Реестр транзакций Saga](../Task1/README.md). [Task2: Таблица переходов состояний](../Task2/README.md)
2. Автор ADR: Швецов Александр
3. Статус: [На согласовании]

## Контекст
В OrchestrPay платёжный процесс — сложная Saga-оркестрация (9 транзакций по Task1, state machine с ветками по Task2), с Camunda BPMN для компенсаций (авто-возвраты при фроде/сбоях), проверками (AML, ручная 20 мин + cut-off) и интеграциями (внешние API с retry). Текущая микросервисная архитектура (Payment, FraudCheck, Notification) требует решения: где разместить оркестратор, чтобы сохранить SLA, избежать "зависших" денег и масштабировать под B2B/B2C. Проблема: смешение логики в домене усложнит эволюцию (добавление compliance), но отдельный сервис добавит overhead для MVP.
## Рассмотренные варианты

### Вариант №1 «оркестратор внутри домена»
Интегрировать Camunda в Payment Service: оркестрация запускается при инициации платежа, вызывает другие сервисы напрямую (REST/gRPC), состояния в Redis/PostgreSQL локально. Подходит для MVP — минимальные изменения.
### Вариант №2 «отдельный сервис оркестратора»
Выделить dedicated Orchestrator Service на Camunda: координирует Saga через события (Kafka), Payment фокусируется на транзакциях (CHARGE/CREDIT). Состояния централизованы, легко масштабировать.

## Сравнение альтернатив
| Вариант решения                            | Преимущества                                                                                                                                                                                                                                                           | Недостатки                                                                                                                                                                                                                                                                                      |
| ------------------------------------------ | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| Вариант №1 «оркестратор внутри домена»     | - Простота реализации: интегрируется в существующий Payment Service без дополнительных компонентов. <br>- Не меняет количество сервисов и деплой-процессов. <br>- Низкая задержка (latency <5 сек за счет прямых вызовов).                                             | - Не предназначен для большого количества сценариев. <br>- Смешение доменной логики и оркестрации, сложнее развивать. <br>- Реализация только для одного домена. <br>- Риск каскадных сбоев: падение Payment Service блокирует всю Saga. <br>- Трудно переиспользовать для новых доменов (B2B). |
| Вариант №2 «отдельный сервис оркестратора» | - Лучшее наблюдение и гибкость при изменении бизнес-процессов. <br> - Легче дорабатывать и развивать. <br>- Проще переиспользовать. <br>- Централизованное состояние Saga, легко дорабатывать BPMN с бизнесом.  <br>- Более безопасный к падениям <br>- Изоляция сбоев | - Дополнительные затраты: требует ресурсов на разработку, поддержку и деплой отдельного сервиса. <br>- Развернут дополнительный отдельный сервис.                  <br> - Увеличенная сложность на старте                                                                                       |

## Принятое решение
Вариант №1 «Оркестратор внутри доменного сервиса (Payment Service)».

**Обоснование**: Для MVP (текущий фокус: базовая Saga с FraudCheck/уведомлениями) простота и низкий overhead критичны — соответствует целям (быстрый деплой, SLA без доп. latency). Минусы (смешение логики) приемлемы на этапе окупаемости. таблица показывает баланс (плюсы простоты > гибкости сейчас). Roadmap: после достижения [метрика, e.g., 1000 TPS или окупаемости] — миграция на Вариант 2 для масштаба (изоляция под Security/DevOps). Это решение минимизирует риски "зависших" денег, сохраняя фокус на стабильности.